Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.
Try the new cross-platform PowerShell https://aka.ms/pscore6
PS C:\Users\patrik\PycharmProjects\moje-clanky-api-3> .\deploy_windows_lighter_tests.bat
(venv) C:\Users\patrik\PycharmProjects\moje-clanky-api-3>git fetch
(venv) C:\Users\patrik\PycharmProjects\moje-clanky-api-3>git pull
Already up to date.
(venv) C:\Users\patrik\PycharmProjects\moje-clanky-api-3>call C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\Scripts\activate
======================================================================================== test session starts =========================================================================================
platform win32 -- Python 3.8.10, pytest-7.1.3, pluggy-1.0.0
rootdir: C:\Users\patrik\PycharmProjects\moje-clanky-api-3\tests, configfile: pytest.ini
plugins: typeguard-2.13.3
collected 32 items

tests\test_integration\test_only_local_working_methods\test_content_based_local.py .........F......                                                                              [ 50%]
tests\test_integration\test_only_local_working_methods\test_data_queries.py ..........                                                                                           [ 81%]
tests\test_integration\test_only_local_working_methods\test_hybrid.py ...F.                                                                                                      [ 96%]
tests\test_integration\test_only_local_working_methods\test_user_relevance_classifier.py .                                                                                       [100%]

====================================================================================== FAILURES =======================================================================================
_______________________________________________________________________________ test_evaluation_results _______________________________________________________________________________

    def test_evaluation_results():
        source = "cswiki"
        test_file_name = 'test_doc2vec_final_evaluation_results_'
>       find_best_doc2vec_model(source=source)

tests\test_integration\test_only_local_working_methods\test_content_based_local.py:172:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\recommender_core\recommender_algorithms\content_based_algorithms\doc2vec.py:228: in find_best_doc2vec_model
    train_corpus, test_corpus = prepare_train_test_corpus()
src\recommender_core\recommender_algorithms\content_based_algorithms\doc2vec.py:157: in prepare_train_test_corpus
    sentences, db = build_sentences()
src\recommender_core\data_handling\reader.py:80: in build_sentences
    for document in cursor:
venv\lib\site-packages\pymongo\cursor.py:1248: in next
    if len(self.__data) or self._refresh():
venv\lib\site-packages\pymongo\cursor.py:1139: in _refresh
    self.__session = self.__collection.database.client._ensure_session()
venv\lib\site-packages\pymongo\mongo_client.py:1712: in _ensure_session
    return self.__start_session(True, causal_consistency=False)
venv\lib\site-packages\pymongo\mongo_client.py:1657: in __start_session
    self._topology._check_implicit_session_support()
venv\lib\site-packages\pymongo\topology.py:538: in _check_implicit_session_support
    self._check_session_support()
venv\lib\site-packages\pymongo\topology.py:554: in _check_session_support
    self._select_servers_loop(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <Topology <TopologyDescription id: 633d7248e5d9d2078212e8fd, topology_type: Unknown, servers: [<ServerDescription ('lo...localhost:27017: [WinError 10061] Nemohlo být vytvořeno
žádné připojení, protože cílový počítač je aktivně odmítl')>]>>
selector = <function readable_server_selector at 0x000001DF984EF9D0>, timeout = 30, address = None

    def _select_servers_loop(self, selector, timeout, address):
        """select_servers() guts. Hold the lock when calling this."""
        now = time.monotonic()
        end_time = now + timeout
        server_descriptions = self._description.apply_selector(
            selector, address, custom_selector=self._settings.server_selector
        )

        while not server_descriptions:
            # No suitable servers.
            if timeout == 0 or now > end_time:
>               raise ServerSelectionTimeoutError(
                    "%s, Timeout: %ss, Topology Description: %r"
                    % (self._error_message(selector), timeout, self.description)
                )
E               pymongo.errors.ServerSelectionTimeoutError: localhost:27017: [WinError 10061] Nemohlo být vytvořeno žádné připojení, protože cílový počítač je aktivně odmítl, Timeout:
30s, Topology Description: <TopologyDescription id: 633d7248e5d9d2078212e8fd, topology_type: Unknown, servers: [<ServerDescription ('localhost', 27017) server_type: Unknown, rtt: None,
 error=AutoReconnect('localhost:27017: [WinError 10061] Nemohlo být vytvořeno žádné připojení, protože cílový počítač je aktivně odmítl')>]>

venv\lib\site-packages\pymongo\topology.py:238: ServerSelectionTimeoutError
-------------------------------------------------------------------------------- Captured stdout call ---------------------------------------------------------------------------------
Building sentences...
Building sentences...
_____________________________________________________________________ test_svm_classifier_bad_sample_number[None] _____________________________________________________________________

tested_input = None

    @pytest.mark.parametrize("tested_input", [
        '',
        (),
        None,
        'ratings'
    ])
    def test_svm_classifier_bad_sample_number(tested_input):
        with pytest.raises(ValueError):
            svm = Classifier()
>           assert svm.predict_relevance_for_user(use_only_sample_of=tested_input, user_id=431, relevance_by='stars')

tests\test_integration\test_only_local_working_methods\test_hybrid.py:32:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\recommender_core\recommender_algorithms\user_based_algorithms\user_relevance_classifier\classifier.py:384: in predict_relevance_for_user
    predict_from_vectors(X_unseen_df=X_validation, clf=clf_svc, user_id=user_id,
src\recommender_core\recommender_algorithms\user_based_algorithms\user_relevance_classifier\classifier.py:96: in predict_from_vectors
    y_pred_unseen = X_unseen_df \
venv\lib\site-packages\pandas\core\frame.py:8740: in apply
    return op.apply()
venv\lib\site-packages\pandas\core\apply.py:688: in apply
    return self.apply_standard()
venv\lib\site-packages\pandas\core\apply.py:812: in apply_standard
    results, res_index = self.apply_series_generator()
venv\lib\site-packages\pandas\core\apply.py:828: in apply_series_generator
    results[i] = self.f(v)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

x = category_title                                                    Test-Category
all_features_preprocessed             ...        test5
bert_vector_representation    [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
Name: 3806, dtype: object

        .apply(lambda x: clf
>              .predict(pickle
                        .loads(x['bert_vector_representation']))[0]
    if pd.notnull(x['bert_vector_representation'])
    else clf.predict(bert_model(' '.join(str(x[col_to_combine]))).vector.reshape(1, -1))[0], axis=1)
E   _pickle.UnpicklingError: invalid load key, '\xef'.

src\recommender_core\recommender_algorithms\user_based_algorithms\user_relevance_classifier\classifier.py:98: UnpicklingError
-------------------------------------------------------------------------------- Captured stdout call ---------------------------------------------------------------------------------
type(column_name)
<class 'NoneType'>
sql_query:
SELECT * FROM users ORDER BY id;
all_user_df.columns
Index(['id', 'name', 'email', 'email_verified_at', 'password', 'token',
       'remember_token', 'created_at', 'updated_at', 'slug', 'bio',
       'recommended_by_svd', 'recommended_by_user_keywords',
       'recommended_by_best_rated_by_others_in_user_categories'],
      dtype='object')
df_ratings
     rating_id  ...                                          full_text
0         1348  ...
1         1382  ...  Už v červnu se dostala na svobodu i jeho manže...
2         1382  ...  Už v červnu se dostala na svobodu i jeho manže...
3         1382  ...  Už v červnu se dostala na svobodu i jeho manže...
4         1382  ...  Už v červnu se dostala na svobodu i jeho manže...
..         ...  ...                                                ...
100    9999999  ...                                               test
101     999998  ...                                               test
102    9999998  ...                                               test
103    9999997  ...                                               test
104       1429  ...  Čtyřicet pět metrů – přesně takovou vzdálenost...

[105 rows x 11 columns]
df_ratings after drop_duplicates
     rating_id  ...                                          full_text
27        1408  ...  Narodil se v Praze, nedaleko tehdejší domoviny...
28        1410  ...  Je to trochu podobné jako s chytrými telefony,...
48        1413  ...  Jejich situace je ovšem podobně zoufalá jako k...
36        1427  ...  Staronová klasika, tak by se optikou několika ...
35        1428  ...  Aletsch. Ledová pýcha švýcarského kantonu Wall...
104       1429  ...  Čtyřicet pět metrů – přesně takovou vzdálenost...

[6 rows x 11 columns]
Getting posts from SQL...
posts_df
            id  ...                         bert_vector_representation
0         1004  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
1         1005  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
2         1006  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
3         1007  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
4         1009  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
...        ...  ...                                                ...
3806    999997  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3807    999998  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3808    999999  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3809   9999999  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3810  99999999  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...

[3811 rows x 42 columns]
Index(['id', 'author_id', 'post_title', 'slug', 'excerpt', 'body',
       'original_link', 'image', 'created_at', 'updated_at', 'published_at',
       'category_id', 'views', 'deleted_at', 'keywords', 'recommended',
       'meta_id', 'titlePreprocessed', 'excerptPreprocessed',
       'all_features_preprocessed', 'full_text', 'body_preprocessed',
       'recommended_word2vec', 'recommended_word2vec_full_text',
       'recommended_tfidf', 'recommended_tfidf_full_text',
       'recommended_doc2vec', 'recommended_doc2vec_full_text',
       'recommended_lda', 'recommended_lda_full_text',
       'doc2vec_representation', 'trigrams_short_text', 'trigrams_full_text',
       'recommended_word2vec_eval_1', 'recommended_word2vec_eval_2',
       'recommended_word2vec_eval_3', 'recommended_word2vec_eval_4',
       'recommended_word2vec_limited_fasttext',
       'recommended_word2vec_limited_fasttest_full_text',
       'recommended_word2vec_eval_cswiki_1',
       'recommended_doc2vec_eval_cswiki_1', 'bert_vector_representation'],
      dtype='object')
categories_df
        id category_title  ... created_at updated_at
0        1      Ekonomika  ...       None       None
1        2     Regionální  ...       None       None
2        3      Zahraničí  ...       None       None
3        4         Domácí  ...       None       None
4        5        Kultura  ...       None       None
5        6        Finance  ...       None       None
6        7           Móda  ...       None       None
7        8         Zdraví  ...       None       None
8        9         Vztahy  ...       None       None
9       11      Celebrity  ...       None       None
10      12    Technologie  ...       None       None
11      13           Věda  ...       None       None
12      14      Auto-moto  ...       None       None
13      15            Hry  ...       None       None
14      16        Ostatní  ...       None       None
15      17          Sport  ...       None       None
16  999999  Test-Category  ...       None       None

[17 rows x 6 columns]
Index(['id', 'category_title', 'description', 'category_slug', 'created_at',
       'updated_at'],
      dtype='object')
Loading user's personalized classifiers models for user 431
Loading SVC...
Loading Random Forest...
=========================
Inserting by SVC:
=========================
X_validation:
     category_title  ...                         bert_vector_representation
0            Domácí  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
1            Domácí  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
2            Domácí  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
3            Domácí  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
4            Domácí  ...  [b'\x80', b'\x04', b'\x95', b'\x8e', b'\x0c', ...
...             ...  ...                                                ...
3806  Test-Category  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3807  Test-Category  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3808  Test-Category  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3809  Test-Category  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...
3810  Test-Category  ...  [b'\xef', b'\xbb', b'\xbf', b'0', b'0', b'0', ...

[3811 rows x 5 columns]
clf_svc:
RandomForestClassifier(max_depth=9, random_state=0)
predict_from_vectors method
Vectoring the selected columns...
X_unseen_df:
Loading vectors or creating new if does not exists...
================================================================================== warnings summary ===================================================================================
venv\lib\site-packages\gensim\matutils.py:22
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\gensim\matutils.py:22: DeprecationWarning: Please use `triu` from the `scipy.linalg` namespace, the `scipy.li
nalg.special_matrices` namespace is deprecated.
    from scipy.linalg.special_matrices import triu

venv\lib\site-packages\sklearn\utils\multiclass.py:14
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\sklearn\utils\multiclass.py:14: DeprecationWarning: Please use `spmatrix` from the `scipy.sparse` namespace,
the `scipy.sparse.base` namespace is deprecated.
    from scipy.sparse.base import spmatrix

venv\lib\site-packages\sklearn\utils\optimize.py:18
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\sklearn\utils\optimize.py:18: DeprecationWarning: Please use `line_search_wolfe2` from the `scipy.optimize` n
amespace, the `scipy.optimize.linesearch` namespace is deprecated.
    from scipy.optimize.linesearch import line_search_wolfe2, line_search_wolfe1

venv\lib\site-packages\sklearn\utils\optimize.py:18
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\sklearn\utils\optimize.py:18: DeprecationWarning: Please use `line_search_wolfe1` from the `scipy.optimize` n
amespace, the `scipy.optimize.linesearch` namespace is deprecated.
    from scipy.optimize.linesearch import line_search_wolfe2, line_search_wolfe1

venv\lib\site-packages\past\builtins\misc.py:45
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\past\builtins\misc.py:45: DeprecationWarning: the imp module is deprecated in favour of importlib; see the mo
dule's documentation for alternative uses
    from imp import reload

test_integration/test_only_local_working_methods/test_content_based_local.py::test_user_keywords
test_integration/test_only_local_working_methods/test_content_based_local.py::test_tfidf_vectorizer_loading
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\src\recommender_core\recommender_algorithms\content_based_algorithms\tfidf.py:60: DeprecationWarning: Please use `csr_matrix` from t
he `scipy.sparse` namespace, the `scipy.sparse.csr` namespace is deprecated.
    vectorizer = pickle.load(open(path, "rb"))

test_integration/test_only_local_working_methods/test_content_based_local.py::test_word2vec_method
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\gensim\similarities\termsim.py:382: RuntimeWarning: divide by zero encountered in true_divide
    normalized_corpus = np.multiply(corpus, 1.0 / corpus_norm)

test_integration/test_only_local_working_methods/test_content_based_local.py::test_word2vec_method
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\gensim\similarities\termsim.py:382: RuntimeWarning: invalid value encountered in multiply
    normalized_corpus = np.multiply(corpus, 1.0 / corpus_norm)

test_integration/test_only_local_working_methods/test_hybrid.py::test_svm_classifier_bad_sample_number[None]
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\sklearn\base.py:324: UserWarning: Trying to unpickle estimator DecisionTreeClassifier from version 0.24.2 whe
n using version 1.0.1. This might lead to breaking code or invalid results. Use at your own risk. For more info please refer to:
  https://scikit-learn.org/stable/modules/model_persistence.html#security-maintainability-limitations
    warnings.warn(

test_integration/test_only_local_working_methods/test_hybrid.py::test_svm_classifier_bad_sample_number[None]
  C:\Users\patrik\PycharmProjects\moje-clanky-api-3\venv\lib\site-packages\sklearn\base.py:324: UserWarning: Trying to unpickle estimator RandomForestClassifier from version 0.24.2 whe
n using version 1.0.1. This might lead to breaking code or invalid results. Use at your own risk. For more info please refer to:
  https://scikit-learn.org/stable/modules/model_persistence.html#security-maintainability-limitations
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================================================================== short test summary info ===============================================================================
FAILED tests\test_integration\test_only_local_working_methods\test_content_based_local.py::test_evaluation_results - pymongo.errors.ServerSelectionTimeoutError: localhost:27017: [Wi...

FAILED tests\test_integration\test_only_local_working_methods\test_hybrid.py::test_svm_classifier_bad_sample_number[None] - _pickle.UnpicklingError: invalid load key, '\xef'.
=============================================================== 2 failed, 30 passed, 11 warnings in 2535.54s (0:42:15) ================================================================
PS C:\Users\patrik\PycharmProjects\moje-clanky-api-3>

